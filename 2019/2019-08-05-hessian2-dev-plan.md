<!---
markmeta_title: 对golang hessian未来开发方向的思考
markmeta_author: 望哥
markmeta_date: 2019-08-05
markmeta_categories: 经验
markmeta_tags: golang,hessian
-->


# 对golang hessian未来开发方向的思考 


参与开发的[golang hessian库](https://github.com/apache/dubbo-go-hessian2)已贡献给apache, 
但其开发似乎遇到瓶颈，现在主要的开发工作都是为了兼容java，适配各种java类型；
另外就是尝试支持一些比较特殊的golang特性，比如多级指针。 
我在想我们是要开发一种大而全、适配各种语言特性和模型、适应各种奇怪的用法吗？
我的答案是否定的。 
我期望的目标是开发一种简单、高效、易于理解的二进制协议。


## 为什么会遇到现在的这种窘境？

hessian协议主要被广泛使用在java应用里面，用户无需定义任何消息格式，hessian协议可以将任何对象进行序列化，对于用户来说这是太方便不过了。
让用户上手即用无需关注细节似乎成为了hessian协议的一个开发原则。
这一原则在单一语言内部还比较好解决，但跨语言后就变得复杂而臃肿。
一种语言要去适配java，就需要把java里面各种exception、原生数据模型都定义一遍，
所有编码验证功能还得以java为标准进行单元测试，而不是参考协议本身。
如果是多语言环境，各种语言两两各自适配，那将更为混乱不堪。


## 如何简单？

显然`让用户上手即用无需关注细节`这一原则并不适应多语言交互的场景，
多语言环境交互应该是有一套统一的标准，包括统一的协议定义和统一的开发模式。

试问一下，语言之间的交互，用户真的会传递各种格式的消息吗？ 
不会！基本消息格式用户还是需要在各种语言中进行定义。 
可能你会说hessian有泛型支持，但所谓泛型也是需要在一定得消息格式范围之类，所有消息格式双方都需要进行定义，完全可以把他看成一种已知的枚举格式。

总的来说：系统接口交互的消息格式都是需要事先定义好的。 

既然要事先定义，也就是说业务逻辑也是可以协商的。
比如整形数据不一定非的要使用java里面的Integer以便使用其null的形式，完全可以调整业务逻辑，用0表示空值零值。

如果都定义一种双方都很容易实现的方式，不使用那些某种语言独有的数据类型，一切就变得简单。
诸如下面这些我觉得应该避免：
- 禁止在消息中传递一种语言特有的对象； 
	- 以异常消息来讲，不能传递java中各种exception；也不能使用golang中的error；而应该使code+message两个字符串内容来替代；
- 禁用一些需要花费特大力气重构去适应、但极少情况使用的语言特性：
	- golang中可以定义多级指针，要让二进制协议去处理多级指针是很麻烦的； 完全可以禁用多级指针，struct只保持一级指针，原始类型禁用指针；


> 【简单的好处】[hessian2协议](http://hessian.caucho.com/doc/hessian-serialization.html) 本身是很简单的，让协议库也保持简单，开发者易于上手，协议库本身的开发也更容易，也会减少出错的几率，让协议更容易在开发者中推广开来。


## 如果高效？

hessian现在在跨语言沟通中，需要在多种语言中分别去单独定义相应的消息格式，然后再联调看消息定义格式是否能够被其他语言正确接收。
这个过程实际上是很繁琐的，但恰恰是可以避免的。

完全可以参考protocol buffer定义proto文件格式，根据proto定义生成各种语言对应的代码。
和社区的同学讨论，觉得这样改动太大，工作量太多。
我觉得proto的定义也可以保持简单，定义格式只需按照协议简单映射过来，无需参杂其他内容，这样代码生成的程序也不会太复杂。

如果再退而求其次，则维护一个映射表，说明协议中的数据类型分别在各种语言中应该用那一种类型来进行定义，开发者开发的时候参考此表即可。



## 开发计划

现在golang hessian库正在各种适配java，已经衍生出了一些问题，结合以上分析，我觉得开发计划中可考虑加入以下内容:
1. golang中禁用多级指针支持，并在注册pojo的时候进行检查；同时代码中可以去掉现有多级指针判断的相关逻辑；
2. 创建一个wiki: `hessian多语言数据类型定义`，作为标准进行推广支持；
3. 创建 `hessian-gen` 项目，定义hessian proto格式，用于生成多语言hessian消息格式代码；


以上！欢迎大家讨论并分享你的观点！





